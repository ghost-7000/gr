-- =====================================================
-- ๐๏ธ GRMC COMPREHENSIVE FIX (IMAGES + ORDERS + ADMIN)
-- =====================================================

-- 1. ุฅุตูุงุญ ุตูุฑ ุงูููุชุฌุงุช (ุงูุชุฃูุฏ ูู ุงููุณุงุฑุงุช ุงูุตุญูุญุฉ)
-- ูููู ุจูุณุญ ุงูููุชุฌุงุช ุงูุชุฌุฑูุจูุฉ ูุถูุงู ุนุฏู ูุฌูุฏ ุชูุฑุงุฑ ุฃู ุตูุฑ ุฎุงุทุฆุฉ
DELETE FROM public.products;

INSERT INTO public.products (code, name, details, liters, price, image, category, stock)
VALUES 
('PNT-WHT-001', 'ุตุจุบ ุฏุงุฎูู ุฃุจูุถ ูุทูู', 'ุทูุงุก ุฏุงุฎูู ุนุงูู ุงูุฌูุฏุฉ ุจููู ุฃุจูุถ ูุงุตุน ูููุณุฉ ููุงุฆูุฉ ูุทููุฉ.', 3.00, 6.00, 'c1 (12).jpeg', 'ุฃุตุจุงุบ ุฏุงุฎููุฉ', 100),
('PNT-WHT-GLS-002', 'ุตุจุบ ุฏุงุฎูู ุฃุจูุถ ูุงูุน', 'ุทูุงุก ุฏุงุฎูู ุจููู ุฃุจูุถ ูุงูุน ูููุญ ุงูุฌุฏุฑุงู ููุณุฉ ุฃูููุฉ ููุดุฑูุฉ.', 3.00, 6.00, 'c1 (1).jpeg', 'ุฃุตุจุงุบ ุฏุงุฎููุฉ', 100),
('PNT-GRY-MAT-003', 'ุตุจุบ ุฏุงุฎูู ุฑุตุงุตู ูุทูู', 'ุทูุงุก ุฏุงุฎูู ุจููู ุฑุตุงุตู ุฃููู ุจููุณุฉ ูุทููุฉ ูุงุนูุฉ.', 3.00, 6.50, 'c1 (5).jpeg', 'ุฃุตุจุงุบ ุฏุงุฎููุฉ', 100),
('PNT-LVND-MAT-004', 'ุตุจุบ ุฏุงุฎูู ุจููุณุฌู ูุงุชุญ ูุทูู', 'ุทูุงุก ุฏุงุฎูู ุจููู ุจููุณุฌู ูุงุชุญ (ูุงููุฏุฑ) ุจููุณุฉ ูุทููุฉ ูุงุนูุฉ.', 3.00, 6.50, 'c1 (10).jpeg', 'ุฃุตุจุงุบ ุฏุงุฎููุฉ', 100),
('PNT-LVND-GLS-005', 'ุตุจุบ ุฏุงุฎูู ุจููุณุฌู ูุงูุน', 'ุทูุงุก ุฏุงุฎูู ุจููู ุจููุณุฌู ุจููุนุฉ ุฃูููุฉ ููุดุฑูุฉ.', 3.00, 6.50, 'c1 (6).jpeg', 'ุฃุตุจุงุบ ุฏุงุฎููุฉ', 100),
('PNT-PNK-MAT-006', 'ุตุจุบ ุฏุงุฎูู ูุฑุฏู ูุงุชุญ ูุทูู', 'ุทูุงุก ุฏุงุฎูู ุจููู ูุฑุฏู ูุงุชุญ ูููุณุฉ ูุทููุฉ ูุงุนูุฉ.', 3.00, 6.50, 'c1 (3).jpeg', 'ุฃุตุจุงุบ ุฏุงุฎููุฉ', 100),
('PNT-YLW-MAT-007', 'ุตุจุบ ุฏุงุฎูู ุฃุตูุฑ ูุงุชุญ ูุทูู', 'ุทูุงุก ุฏุงุฎูู ุจููู ุฃุตูุฑ ูุงุชุญ ุจููุณุฉ ูุทููุฉ ูุงุนูุฉ.', 3.00, 6.50, 'c1 (7).jpeg', 'ุฃุตุจุงุบ ุฏุงุฎููุฉ', 100),
('PNT-ORG-MAT-008', 'ุตุจุบ ุฏุงุฎูู ุจุฑุชูุงูู ูุงุชุญ ูุทูู', 'ุทูุงุก ุฏุงุฎูู ุจููู ุจุฑุชูุงูู ูุงุชุญ ุจููุณุฉ ูุทููุฉ ูููุฒุฉ.', 3.00, 6.50, 'c1 (8).jpeg', 'ุฃุตุจุงุบ ุฏุงุฎููุฉ', 100),
('PNT-BLK-MAT-009', 'ุตุจุบ ุฏุงุฎูู ุฃุณูุฏ ูุทูู', 'ุทูุงุก ุฏุงุฎูู ุจุงูููู ุงูุฃุณูุฏ ุงููุทูู ุงููุงุฎุฑ.', 3.00, 6.50, 'c1 (9).jpeg', 'ุฃุตุจุงุบ ุฏุงุฎููุฉ', 100),
('PNT-BRN-MAT-010', 'ุตุจุบ ุจูู ูุทูู ูุงุฎุฑ', 'ุทูุงุก ุฏุงุฎูู ุจููู ุจูู ูุทูู ุฏุงูุฆ ูุฃููู.', 3.00, 6.50, 'c1 (4).jpeg', 'ุฃุตุจุงุบ ุฏุงุฎููุฉ', 100),
('PNT-GRN-MAT-011', 'ุตุจุบ ุฏุงุฎูู ุฃุฎุถุฑ ูุงุชุญ ูุทูู', 'ุทูุงุก ุฏุงุฎูู ุจููู ุฃุฎุถุฑ ูุงุชุญ ุจููุณุฉ ูุทููุฉ ูุงุฏุฆุฉ.', 3.00, 6.50, 'c1 (11).jpeg', 'ุฃุตุจุงุบ ุฏุงุฎููุฉ', 100),
('PNT-BLU-MAT-012', 'ุตุจุบ ุฃุฒุฑู ูุงุฎุฑ', 'ุตุจุบ ุฃุฒุฑู ูุชููุฒ ุจูููู ุงูุนููู ูุฌูุฏุชู ุงูุนุงููุฉ.', 3.00, 6.50, 'c1 (2).jpeg', 'ุฃุตุจุงุบ ุฏุงุฎููุฉ', 100);

-- 2. ุชูุญูุฏ ุฃุนูุฏุฉ ุฌุฏูู ุงูุทูุจุงุช ูุถูุงู ุนุฏู ุญุฏูุซ ูุดู ุนูุฏ ุงูุญูุธ
-- ูุชุฃูุฏ ูู ูุฌูุฏ ุงูุนููุฏูู total ู total_price ูุชุฌูุจ ุฃู ุชุนุงุฑุถ ูู ุงูููุฏ
DO $$ 
BEGIN 
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='orders' AND column_name='total_price') THEN
        ALTER TABLE public.orders ADD COLUMN total_price NUMERIC(10,3) DEFAULT 0;
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='orders' AND column_name='total') THEN
        ALTER TABLE public.orders ADD COLUMN total NUMERIC(10,3) DEFAULT 0;
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='orders' AND column_name='placed_on') THEN
        ALTER TABLE public.orders ADD COLUMN placed_on TIMESTAMPTZ DEFAULT now();
    END IF;
END $$;

-- 3. ุชุญุฏูุซ ุตูุงุญูุงุช ุงููุณุคูู (Admin) ูุถูุงู ุฑุคูุฉ ุงูุทูุจุงุช
-- ุงุณุชุจุฏู ุงูุฅูููู ุฃุฏูุงู ุจุฅููููู ุงูุฐู ุชุณุชุฎุฏูู ูุชุณุฌูู ุงูุฏุฎูู
UPDATE public.profiles SET role = 'admin' WHERE email = 'admin@grmc.com';

-- 4. ุฅููุงู RLS ูุคูุชุงู ูุฌุฏูู ุงูุทูุจุงุช ููุชุฃูุฏ ูู ูุตูู ุงููุณุคูู ููู ุดูุก (ุงุฎุชูุงุฑู ููู ุขูู)
ALTER TABLE public.orders DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;

-- ุณูุงุณุฉ ุชุณูุญ ูููุณุคูู ุจุฑุคูุฉ ูู ุดูุก
DROP POLICY IF EXISTS "Admins can view all orders" ON public.orders;
CREATE POLICY "Admins can view all orders" ON public.orders 
FOR SELECT USING (EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin'));

-- ุณูุงุณุฉ ุชุณูุญ ูููุณุคูู ุจุชุญุฏูุซ ุงูุญุงูุฉ
DROP POLICY IF EXISTS "Admins can update orders" ON public.orders;
CREATE POLICY "Admins can update orders" ON public.orders 
FOR UPDATE USING (EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin'));
